apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "application-template.fullname" . }}-test-connection"
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "application-template.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: test-actuator-health
      image: {{.Values.busyboxImage.repository }}:{{.Values.busyboxImage.tag }}
      imagePullPolicy: {{.Values.busyboxImage.pullPolicy }}
      command: [ '/bin/sh', '-c' ]
      args:
        - |
          echo "::group::Application Deployment Status"
          echo "Checking status of $APPLICATION_NAME (version $APP_VERSION) in namespace $NAMESPACE"
          echo "Helm Release Details:"
          helm status $APPLICATION_NAME --namespace ${NAMESPACE}
          echo "::endgroup::"

          echo "::group::Helm Test Raw Output"
          echo "Testing Application $APPLICATION_NAME: $APP_VERSION"
          TEST_OUTPUT=$(helm test $APPLICATION_NAME --namespace ${NAMESPACE} --logs)
          TEST_EXIT_CODE=$?
          echo "Exit Code: $TEST_EXIT_CODE"
          echo "$TEST_OUTPUT"
          echo "::endgroup::"

          # Check all test exit codes
          if echo "$TEST_OUTPUT" | grep -q "Exit code: [^0]"; then
            echo "::error::One or more Helm tests failed. See details above:"
            exit 1
          elif [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "::error::Helm test command failed with exit code $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          else
            echo "All Helm tests passed successfully."
          fi

  restartPolicy: Never
